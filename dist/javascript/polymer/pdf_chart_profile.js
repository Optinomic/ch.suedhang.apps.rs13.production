Polymer({is:"optinomic-pdf-chart-profile",properties:{language:{type:String,value:"de"},options:{type:Object,observer:"__init"},start:{type:Object},clinic_samples:{type:Object,observer:"__init"},clinic_sample_dive:{type:Array,observer:"__init"},scales:{type:Object,observer:"__init"},scores:{type:Object,observer:"__init"},ranges:{type:Object,observer:"__init"},pdfContent:{type:Object,notify:!0,reflectToAttribute:!0}},__init:function(){this.debounce("_srChanged",function(){this._hasValue(this.options)&&this._hasValue(this.scales)&&this._hasValue(this.scores)&&this._hasValue(this.ranges)&&this._pdfmake_chart_zscore(this.scores,this.options)},250)},_pdfmake_chart_zscore:function(scores,definition){var d,_return,_inner,_init=function(scores,definition){var d={};d.options=definition,d.options.offset_top=10,"item_height"in d.options?d.options.item_height=d.options.item_height:d.options.item_height=60,"topnumber_hide_first_last"in d.options?d.options.topnumber_hide_first_last=d.options.topnumber_hide_first_last:d.options.topnumber_hide_first_last=!1,"show_ranges_overview"in d.options?d.options.show_ranges_overview=d.options.show_ranges_overview:d.options.show_ranges_overview=!0,"item_text_left"in d.options?d.options.item_text_left=d.options.item_text_left:d.options.item_text_left=73,"item_text_right"in d.options?d.options.item_text_right=d.options.item_text_right:d.options.item_text_right=73,"dropout_flag"in d.options?d.options.dropout_flag=d.options.dropout_flag:d.options.dropout_flag=null,"dropout_reason"in d.options?d.options.dropout_reason=d.options.dropout_reason:d.options.dropout_reason=null;d.options.item_text_left=d.options.item_text_left/2+12,d.options.item_text_right=d.options.item_text_right/2+12,d.options.item_text_left<=62?d.options.legend_left=62:d.options.legend_left=d.options.item_text_left,d.options.chart_width=495-d.options.item_text_left-d.options.item_text_right;"show_scale_text"in d.options&&d.options.show_scale_text;"color_grid"in d.options&&d.options.color_grid,d.scales=this.get("scales"),d.scales.length>0?d.options.chart_height=d.scales.length*d.options.item_height:d.options.chart_height=0,d.ranges=this.get("ranges"),null!==this.clinic_samples&&void 0!==this.clinic_samples?d.ks=this.clinic_samples:d.ks=null;var ks_dive={defined:!1,text:"",data:null,array:[]},clinic_sample_dive=this.get("clinic_sample_dive");return null!==clinic_sample_dive&&void 0!==clinic_sample_dive&&(ks_dive.array=clinic_sample_dive,ks_dive.array.length>0&&(ks_dive.defined=!0)),d.ks_dive=ks_dive,d.options.do_min=!1,"auto"===d.options.min||void 0===d.options.min?d.options.do_min=!0:d.options.item_min=parseInt(d.options.min),d.options.do_max=!1,"auto"===d.options.max||void 0===d.options.max?d.options.do_max=!0:d.options.item_max=parseInt(d.options.max),d.scores=scores.data,d.scores.length>0?(d.have_data=!0,d=_scales_scores(d.scores,d),d=_autoMinMax(d)):d.have_data=!1,console.log("<optinomic-pdf-chart-profile>",d),d}.bind(this),_ks_current_sample=function(d){d.scores[d.scores.length-1];var clinic_sample_dive={defined:!1,text:"",data:null,array:[]};if(d.ks_dive.defined&&(clinic_sample_dive=d.ks_dive),!d.ks_dive.defined&&this._hasValue(this.clinic_samples)&&(this.clinic_samples.dimensions.forEach(function(dim,dimID){clinic_sample_dive.array.push(dim.array.length-1)}),console.log("Defaultstichprobe erstellt!")),d.ks_dive.defined&&this._hasValue(this.clinic_samples)){var dive_data=d.ks.data;d.ks_dive.array.forEach(function(dive,diveID){dive_data=JSON.parse(JSON.stringify(dive_data[dive]))});try{clinic_sample_dive.data=JSON.parse(JSON.stringify(dive_data.statistics))}catch(err){clinic_sample_dive.data={}}var n_value=0;for(var property in clinic_sample_dive.data)clinic_sample_dive.data.hasOwnProperty(property)&&(n_value=clinic_sample_dive.data[property].n);clinic_sample_dive.text="",d.ks.dimensions.forEach(function(dim,dimID){var pos=d.ks_dive.array[dimID],dim_text=dim.name+": "+dim.array[pos].text;dimID!==d.ks.dimensions.length-1&&(dim_text+=", "),clinic_sample_dive.text=clinic_sample_dive.text+dim_text}),0!==n_value&&(clinic_sample_dive.text=clinic_sample_dive.text+" (N="+n_value+")"),clinic_sample_dive.defined=!0}return clinic_sample_dive}.bind(this),_scales_scores=function(scores,init){return init.scales.forEach(function(scale,scaleID){scale.scores=[],scale.id=scaleID,void 0!==scores&&null!==scores&&scores.forEach(function(score,scoreID){var score_obj={value:null,title:"Unbekannt",date:null,dropout:!1,dropout_reason:null};scale.score_path&&(score_obj.value=_getDataPath(score,scale.score_path)),init.options.response_title_path&&(score_obj.title=_getDataPath(score,init.options.response_title_path)),init.options.response_date_path&&(score_obj.date=_getDataPath(score,init.options.response_date_path),score_obj.date=_formatDateCH(score_obj.date)),"dropout_flag"in init.options&&""!==init.options.dropout_flag&&null!==init.options.dropout_flag&&void 0!==init.options.dropout_flag&&(score_obj.dropout=_getDataPath(score,init.options.dropout_flag)),"dropout_reason"in init.options&&""!==init.options.dropout_reason&&null!==init.options.dropout_reason&&void 0!==init.options.dropout_reason&&(score_obj.dropout_reason=_getDataPath(score,init.options.dropout_reason)),scale.scores.push(score_obj)})}),init}.bind(this),_legende_normstichprobe=function(init){if("norm_sample"in init.options){if(this._hasValue(init.options.norm_sample))var normstichprobe={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:"Normstichprobe"}]},{width:"*",style:"chart_p",alignment:"left",text:[{text:init.options.norm_sample}]}],columnGap:10}}else normstichprobe={};return normstichprobe}.bind(this),_legende_start=function(init){var start=this.get("start"),return_object={};if(void 0!==start&&1==init.ks_dive.defined)return_object={columns:[{width:init.options.item_text_left,style:"chart_p",alignment:"right",color:start.left_color,text:start.left_title},{width:"*",style:"chart_p",alignment:"left",text:[{text:start.left_text}]},{width:"*",style:"chart_p",alignment:"right",text:[{text:start.right_text}]},{width:init.options.item_text_right,style:"chart_p",alignment:"left",color:start.right_color,text:start.right_title}],columnGap:10};return return_object}.bind(this),_getDataPath=function(current_score,path){var data_dive=JSON.parse(JSON.stringify(current_score)),dots_count=path.split(".").length-1;if(0===dots_count)return data_dive[path];var dive=[];for(i=0;i<dots_count;i++){var n=path.indexOf("."),item=path.substring(0,n);path=path.substring(n+1,path.length),dive.push(item),i===dots_count-1&&dive.push(path)}for(i=0;i<dive.length;i++)if(data_dive=data_dive[dive[i]],i===dots_count)return data_dive},_autoMinMax=function(data){var d=JSON.parse(JSON.stringify(data));return(d.options.do_max||d.options.do_min)&&(d.options.do_min&&(d.options.item_min=0),d.options.do_max&&(d.options.item_max=0),d.scales.forEach(function(scale,scaleID){scale.scores.forEach(function(score,scoreID){d.options.do_min&&score.value<d.options.item_min&&(d.options.item_min=score.value),d.options.do_max&&score.value>d.options.item_max&&(d.options.item_max=score.value)})}),d.options.do_min?(d.options.item_min<0?(d.options.item_min=Math.ceil(Math.abs(d.options.item_min))+1,d.options.item_min=-1*d.options.item_min):d.options.item_min=Math.ceil(Math.abs(d.options.item_min))+1,d.options.item_min>0&&(d.options.item_min=0)):d.options.item_min=d.options.min,d.options.do_max?d.options.item_max<0?(d.options.item_max=Math.ceil(Math.abs(d.options.item_max))+1,d.options.item_max=-1*d.options.item_max):d.options.item_max=Math.ceil(Math.abs(d.options.item_max))+1:d.options.item_max=d.options.max),d.options.min_max_range=d.options.item_max-d.options.item_min,d.options.item_min<0&&(d.options.min_max_range=d.options.item_max+Math.abs(d.options.item_min)),d},_getXPos=function(min,max,svg_width_100,current_value){var width_value=null;if(void 0!==current_value){var width_100=Math.abs(min)+Math.abs(max);width_value=svg_width_100/width_100*(current_value+Math.abs(min)),width_value_max=svg_width_100/width_100*(Math.abs(max)+Math.abs(min)),width_value>width_value_max&&(width_value=width_value_max),width_value<0&&(width_value=0)}return width_value},_shadeColor=function(color,percent){var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?-1*percent:percent,R=f>>16,G=f>>8&255,B=255&f;return"#"+(16777216+65536*(Math.round((t-R)*p)+R)+256*(Math.round((t-G)*p)+G)+(Math.round((t-B)*p)+B)).toString(16).slice(1)},_getColor=function(id,color_skin){var colors=[];return"default"===(color_skin=void 0===color_skin?"default":color_skin)&&(colors.push("#3F51B5"),colors.push("#E91E63"),colors.push("#00BCD4"),colors.push("#8BC34A"),colors.push("#FFC107"),colors.push("#795548"),colors.push("#673AB7"),colors.push("#F44336"),colors.push("#03A9F4"),colors.push("#4CAF50"),colors.push("#FFEB3B"),colors.push("#FF5722"),colors.push("#2196F3"),colors.push("#9C27B0"),colors.push("#009688"),colors.push("#CDDC39"),colors.push("#FF9800"),colors.push("#607D8B")),"grey_dark_to_light"===color_skin&&(colors.push("#424242"),colors.push("#9E9E9E"),colors.push("#E0E0E0"),colors.push("#FAFAFA")),"indigo_dark_to_light"===color_skin&&(colors.push("#283593"),colors.push("#3F51B5"),colors.push("#7986CB"),colors.push("#E8EAF6")),"pink_dark_to_light"===color_skin&&(colors.push("#AD1457"),colors.push("#E91E63"),colors.push("#7986CB"),colors.push("#E8EAF6")),"indigo_grey_pink"===color_skin&&(colors.push("#1A237E"),colors.push("#212121"),colors.push("#880E4F"),colors.push("#3F51B5"),colors.push("#9E9E9E"),colors.push("#E91E63"),colors.push("#C5CAE9"),colors.push("#F5F5F5"),colors.push("#F8BBD0")),"zebra"===color_skin&&(colors.push("#212121"),colors.push("#EEEEEE")),id>colors.length-1?colors[id-Math.floor(id/colors.length)*colors.length]:colors[id]},_formatDateCH=function(date_string){if(void 0!==date_string&&null!==date_string){var year=parseInt(date_string.substring(0,4)),month=parseInt(date_string.substring(5,7));return parseInt(date_string.substring(8,10))+"."+month+"."+year}return null},init=_init(scores,definition),chart_stack=[],chart_top=[];if(!0===init.have_data){chart_stack.push(function(d){var _scales_text={id:"scales_text",stack:[]};return d.scales.length>0&&d.scales.forEach(function(scale,scaleID){var left_text=[],right_text=[];if(""!==scale.left_title)if(""!==scale.left_text&&d.options.show_scale_text){var title={text:scale.left_title+": ",bold:!0},text={text:scale.left_text,bold:!1};left_text.push(title),left_text.push(text)}else title={text:scale.left_title,bold:!0},left_text.push(title);else""!==scale.left_text&&(text={text:scale.left_text,bold:!1},left_text.push(text));""!==scale.right_title?""!==scale.right_text&&d.options.show_scale_text?(title={text:scale.right_title+": ",bold:!0},text={text:scale.right_text,bold:!1},right_text.push(title),right_text.push(text)):(title={text:scale.right_title,bold:!0},right_text.push(title)):""!==scale.right_text&&(text={text:scale.right_text,bold:!1},right_text.push(text));var column_scale={columns:[{width:d.options.item_text_left,style:"chart_p",alignment:"right",text:left_text},{width:"*",text:""},{width:d.options.item_text_right,style:"chart_p",alignment:"left",text:right_text}],relativePosition:{x:0,y:scaleID*d.options.item_height+d.options.offset_top},columnGap:10};_scales_text.stack.push(column_scale)}),_scales_text}(init)),chart_stack.push(function(d){var beschriftung_top={id:"numbers_top",stack:[]},grind_count=0;for(i=0;i<d.options.min_max_range+1;i++)if(0===i||grind_count===d.options.vertical_grid_every_x){var my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,d.options.item_min+i),inner={color:"#616161",fontSize:8,alignment:"left",text:d.options.item_min+i,relativePosition:{x:d.options.item_text_left+8+my_x,y:0}};d.options.topnumber_hide_first_last?0!==i&&i!==d.options.min_max_range&&beschriftung_top.stack.push(inner):beschriftung_top.stack.push(inner),grind_count=1}else grind_count+=1;return beschriftung_top}(init)),chart_stack.push((_return={id:"ranges",stack:[]},_inner={relativePosition:{x:(d=init).options.item_text_left+10,y:d.options.offset_top},canvas:[]},d.ranges.forEach(function(range,rangeID){var my_x=0;-999!==range.range_start&&(my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,range.range_start));var my_y=d.options.chart_width;999!==range.range_stop&&(my_y=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,range.range_stop)),range={type:"rect",x:my_x,y:0,w:my_y-my_x,h:d.options.chart_height,color:_shadeColor(range.color,1-d.options.range_alpha)},_inner.canvas.push(range)}),_return.stack.push(_inner),_return)),null!==init.ks&&chart_stack.push(function(d){var _return={id:"clinic_sample",stack:[]},_inner={relativePosition:{x:d.options.item_text_left+10,y:d.options.offset_top},canvas:[]};d.ks_dive=_ks_current_sample(d);var ks_points=[],ks_line_points=[];d.scales.forEach(function(scale,scaleID){var ks_var=d.ks_dive.data[scale.clinic_sample_var]||{},mean_1sd_min=ks_var.mean_1sd_min||0,mean=(ks_var.mean_1sd_plus,ks_var.mean||0),my_y_1=scaleID*d.options.item_height+7;0===scaleID&&(my_y_1=0);var my_y_2=scaleID*d.options.item_height+(d.options.item_height-7);scaleID===d.scales.length-1&&(my_y_2=d.options.chart_height);var point_1={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_min),y:my_y_1},point_2={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_min),y:my_y_2};ks_points.push(point_1),ks_points.push(point_2);var line_point_1={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean),y:my_y_1},line_point_2={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean),y:my_y_2};ks_line_points.push(line_point_1),ks_line_points.push(line_point_2)});var clone_scales=JSON.parse(JSON.stringify(d.scales));clone_scales.reverse(),clone_scales.forEach(function(scale,scaleID){var scaleIDCorrected=clone_scales.length-1-scaleID,ks_var=d.ks_dive.data[scale.clinic_sample_var]||{},mean_1sd_plus=(ks_var.mean_1sd_min,ks_var.mean_1sd_plus||0),my_y_1=(ks_var.mean,scaleIDCorrected*d.options.item_height+(d.options.item_height-7)),my_y_2=scaleIDCorrected*d.options.item_height+7;0===scaleIDCorrected&&(my_y_2=0),scaleIDCorrected===d.scales.length-1&&(my_y_1=d.options.chart_height);var point_1={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_plus),y:my_y_1},point_2={x:_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,mean_1sd_plus),y:my_y_2};ks_points.push(point_1),ks_points.push(point_2)});var ks_area={type:"polyline",fillOpacity:.5,color:d.options.color_clinic_sample,points:ks_points};_inner.canvas.push(ks_area);var ks_line={type:"polyline",lineWidth:2,lineColor:_shadeColor(d.options.color_grid,.5),points:ks_line_points};return _inner.canvas.push(ks_line),_return.stack.push(_inner),_return}(init)),chart_stack.push(function(d){var _grid={id:"grid",stack:[]},_grid_inner={relativePosition:{x:d.options.item_text_left+10,y:0},canvas:[{type:"rect",x:0,y:d.options.offset_top,w:d.options.chart_width,h:d.options.chart_height,lineColor:d.options.color_grid}]};d.scales.length>0&&d.scales.forEach(function(scale,scaleID){var horizontal_line={type:"line",x1:0,y1:scaleID*d.options.item_height+d.options.offset_top,x2:d.options.chart_width,y2:scaleID*d.options.item_height+d.options.offset_top,lineWidth:1,lineColor:d.options.color_grid};0!==scaleID&&_grid_inner.canvas.push(horizontal_line)});var grind_count=0;for(i=0;i<d.options.min_max_range;i++)if(grind_count===d.options.vertical_grid_every_x){var my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,d.options.item_min+i),line_width=1;d.options.item_min+i===0&&0!==i&&(line_width=2);var vertical_line={type:"line",x1:my_x,y1:d.options.offset_top,x2:my_x,y2:d.options.chart_height+d.options.offset_top,lineWidth:line_width,lineColor:d.options.color_grid};_grid_inner.canvas.push(vertical_line),grind_count=1}else grind_count+=1;return _grid.stack.push(_grid_inner),_grid}(init)),chart_stack.push(function(d){var _return={id:"scores",stack:[]},_inner={relativePosition:{x:d.options.item_text_left+10,y:d.options.offset_top},canvas:[]},points_obj={},lines_count=0,dots=[];for(d.scales.forEach(function(scale,scaleID){scale.scores.forEach(function(score,scoreID){if(!0!==score.dropout){lines_count=scoreID+1,void 0===points_obj[scoreID]&&(points_obj[scoreID]=[]),my_x=_getXPos(d.options.item_min,d.options.item_max,d.options.chart_width,score.value);var my_y=scaleID*d.options.item_height+d.options.item_height/2,point={x:my_x,y:my_y};if(points_obj[scoreID].push(point),d.options.show_score_vertical_line){var show_score_vertical_line={type:"line",x1:my_x,y1:scaleID*d.options.item_height,x2:my_x,y2:scaleID*d.options.item_height+d.options.item_height,lineWidth:4,lineColor:_getColor(scoreID,d.options.color_skin)};_inner.canvas.push(show_score_vertical_line)}if(d.options.show_score_circles){var circle_color="#FFFFFF";d.ranges.forEach(function(range,rangeID){score.value>=range.range_start&&score.value<=range.range_stop&&(circle_color=range.color)});var circle={type:"ellipse",x:my_x,y:my_y,color:circle_color,lineColor:_getColor(scoreID,d.options.color_skin),lineWidth:2,fillOpacity:.9,r1:4.25,r2:4.25};dots.push(circle)}}})}),i=0;i<lines_count;i++){var score_line={type:"polyline",lineWidth:3,lineColor:_getColor(i,d.options.color_skin),points:points_obj[i]};_inner.canvas.push(score_line)}return d.options.show_score_circles&&dots.forEach(function(dot,dotID){_inner.canvas.push(dot)}),_return.stack.push(_inner),_return}(init));var spacer={canvas:[{type:"rect",x:-3,y:0,w:0,h:init.options.offset_top+init.options.chart_height+6,lineColor:"#FFFFFF"}]};chart_stack.push(spacer),chart_stack.push(function(init){var messung_title="Keine Daten vorhanden.";1===init.scores.length&&(messung_title="Messung"),init.scores.length>1&&(messung_title="Messungen");var messungen={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:messung_title}]}],columnGap:10};return init.scores.forEach(function(score,scoreID){"dropout_flag"in init.options&&""!==init.options.dropout_flag&&null!==init.options.dropout_flag&&void 0!==init.options.dropout_flag&&(score.dropout_have=_getDataPath(score,init.options.dropout_flag)),"dropout_reason"in init.options&&""!==init.options.dropout_reason&&null!==init.options.dropout_reason&&void 0!==init.options.dropout_reason&&(score.dropout_reason=_getDataPath(score,init.options.dropout_reason));var zuordner={width:10,canvas:[{type:"line",x1:0,y1:8,x2:15,y2:8,lineWidth:4,lineColor:_getColor(scoreID,init.options.color_skin)}]},title=_getDataPath(score,init.options.response_title_path),date=_getDataPath(score,init.options.response_date_path);date=_formatDateCH(date);var dropout_text="";score.dropout_have?(dropout_text="Dropout: ","dropout_reason"in score&&""!==score.dropout_reason&&(dropout_text=dropout_text+_getDataPath(score,init.options.dropout_reason)+" "),""!==dropout_text&&null!==dropout_text&&"null"!==dropout_text&&(date=date+", "+dropout_text)):messungen.columns.push(zuordner);var beschriftung={width:"*",style:"chart_p",alignment:"left",text:[{text:title},{text:" ("+date+")",color:"#757575"}]};messungen.columns.push(beschriftung)}),messungen}(init)),chart_top.push({text:"",margin:[0,0,0,6]}),chart_top.push(_legende_normstichprobe(init)),chart_top.push(function(init){var return_object={};void 0!==init.ks_dive&&1==init.ks_dive.defined&&(return_object={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:"Klinikstichprobe"}]},{width:"*",style:"chart_p",alignment:"left",text:[{text:init.ks_dive.text}]}],columnGap:10});return return_object}(init)),init.options.show_ranges_overview&&chart_top.push(function(init){var interpretation={columns:[{width:init.options.legend_left,style:"chart_p",color:"#757575",alignment:"right",text:[{text:"Interpretation"}]}],columnGap:10},beschriftung={width:"*",style:"chart_p",alignment:"left",text:[]};return void 0!==init.ranges&&(init.ranges.forEach(function(range,rangeID){var title=range.text,range_text="";-999!==range.range_start?(range_text=range.range_start,999!==range.range_stop&&(range_text=">"+range_text+" bis ")):range_text="<=",999!==range.range_stop?range_text+=range.range_stop:range_text=">="+range_text;var title_obj={text:title},range_obj={text:" ("+range_text+")",color:"#757575"};beschriftung.text.push(title_obj),beschriftung.text.push(range_obj),rangeID!==init.ranges.length-1&&(title_obj={text:", "},beschriftung.text.push(title_obj))}),interpretation.columns.push(beschriftung)),interpretation}(init)),chart_top.push(_legende_start(init)),chart_top.push({text:"",margin:[0,0,0,6]}),chart_stack=chart_top.concat(chart_stack)}var chart={id:"chart_zscore",layout:"noBorders",table:{dontBreakRows:!0,headerRows:0,body:[[{stack:chart_stack}]]}};return this.set("pdfContent",chart),chart},_hasValue:function(value){return null!==value&&"null"!==value&&void 0!==value&&""!==value},ready:function(){},attached:function(){}});