[module]
name = Resilienzfragebogen (RS-13)
short_description = Psychische Widerstandskraft
type = patient
id = ch.suedhang.apps.rs13.production

[dependencies]

[description]
Beschreibung der Applikation. Hinweis: Detaillierte Dokumentation der Applikation im Readme ablegen.

[developer]
first_name = Beat
last_name = Ottiger
github_user = ottigerb
email = beat@optinomic.com
company = Optinomic Gmbh
phone = +41 (0)44 508 26 76
website = https://www.optinomic.com/

[readme]
# Resilienzfragebogen (RS-13) 
The patient-app `ch.suedhang.apps.rs13.production` is currently HOTLOADED!

[template Start 6 6]
<head><meta content="Optinomic GmbH" name="author"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui" name="viewport"></head><div id="optinomic_app"><v-app><v-content><v-container><app-optinomic subtitle="Psychische Widerstandskraft" title="Resilienzfragebogen (RS-13)"><app-rs13></app-rs13><div><v-btn class="ma-2" outlined v-on:click="buttonClick">Increment</v-btn><v-btn class="ma-2" outlined v-on:click="getClinic">getClinic</v-btn><v-btn class="ma-2" outlined v-on:click="buttonTest">Dispatch: Clinic Data</v-btn></div></app-optinomic></v-container></v-content></v-app></div><script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vuex@2.x/dist/vuex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.js"></script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
Vue.component("app-title",{props:{title:{type:String,default:"Optinomic"},subtitle:{type:String,default:"App"}},created(){this.$store.dispatch("getApps")},computed:{readme_html(){return null===this.$store.state.current_app?"<h1>Loading</h1>":this.$store.state.current_app.module.readme.html}},template:'\n        <div style="margin-bottom:24px;">\n            <h1 v-html="title" class="display-2 font-weight-thin"></h1>\n            <p v-html="subtitle" style="margin-left:3px"></p>\n            <v-divider></v-divider>\n        \n            <v-expansion-panels flat light tile>\n                <v-expansion-panel>\n                    <v-expansion-panel-header style="padding:0">\n                        <h2 class="font-weight-light">Dokumentation (Readme)</h2>\n                    </v-expansion-panel-header>\n                    <v-expansion-panel-content>\n                        <div v-html="readme_html"></div>\n                    </v-expansion-panel-content>\n                </v-expansion-panel>\n            </v-expansion-panels>\n        </div>\n    '});
new Vue({el:"#optinomic_app",vuetify:new Vuetify,store:new Vuex.Store({state:{count:0,apps:{},current_app:null,sr:null,clinic:null},mutations:{increment(state){state.count++},saveData(state,d){state[d.root]=d.data,console.warn("state :: ",new Date,state)},saveClinic(state,req){if(200==req.status){console.log(req);var clinic=req.data.clinic,clinic_obj={};clinic.forEach(function(current,ID){clinic_obj[current[0]]=current[1]});var response={data:{error:!1,clinic_array:clinic,clinic_obj:clinic_obj}};console.log("(✔) Data (/clinic):",response)}else{response={error:!0,error_message:"Failed with status code: "+req.status,status_code:req.status};console.error("(!) Error: ",response)}state.clinic=response}},actions:{getSurveyResponses({commit:commit}){var module_identifier=helpers.getAppID(),current_pid=parseInt(helpers.getPatientID()),current_stay_id=parseInt(helpers.getStayID()),base_data={date:new Date,data:null,calculations_all:null,have_data:!1,possible_data:!0,request:null,pid:current_pid,fid:current_stay_id,app_id:module_identifier};console.log("(?) getSurveyResponses",module_identifier,current_pid,current_stay_id),commit({type:"saveData",root:"sr",data:base_data});var calculation_results_api_url="/patients/"+current_pid+"/calculations/"+module_identifier;if(current_stay_id){var api_url="/stays/"+current_stay_id+"/survey_responses/"+module_identifier+"/full";data_request="stay"}else{api_url="/patients/"+current_pid+"/survey_responses/"+module_identifier+"/full";data_request="patient"}helpers.callAPI("GET",api_url,{},{},function(req){var app_id=helpers.getAppID();if(200==req.status){var resp=JSON.parse(req.response);helpers.callAPI("GET",calculation_results_api_url,{},{},function(inner_req){if(200==req.status){var calculation_results=JSON.parse(inner_req.response).calculation_results,return_array=[];if(resp.survey_responses.forEach(function(current_response,srID){var return_obj={all_found:!1,app_id:null};return_obj.date=current_response.data.filled,return_obj.response_id=current_response.id,return_obj.response=current_response.data.response,return_obj.event=null,return_obj.event_found=!1,return_obj.event_id=current_response.data.event_id,return_obj.patient=null,return_obj.patient_found=!1,return_obj.patient_id=null,return_obj.stay=null,return_obj.stay_found=!1,return_obj.stay_id=null,return_obj.patient_uses_module=null,return_obj.patient_uses_module_found=!1,return_obj.patient_uses_module_id=null,return_obj.calculation={},return_obj.calculation_found=!1,return_obj.calculation_found_method=null,resp.events.forEach(function(current_event,eventID){current_event.id===current_response.data.event_id&&(return_obj.event_found=!0,current_event.data.id=current_event.id,return_obj.event=current_event.data,return_obj.patient_uses_module_id=current_event.data.patient_uses_module_id,return_obj.patient_id=current_event.data.patient_id,return_obj.app_id=current_event.data.module,app_id=return_obj.app_id)}),return_obj.event_found&&(resp.patients.forEach(function(current_patient,patientID){current_patient.id===return_obj.patient_id&&(return_obj.patient_found=!0,current_patient.data.id=current_patient.id,current_patient.data.pid=current_patient.id,current_patient.data=createPatientExtras(current_patient.data),return_obj.patient=current_patient.data)}),resp.patient_uses_modules.forEach(function(current_pum,pumID){current_pum.id===return_obj.patient_uses_module_id&&(return_obj.patient_uses_module_found=!0,current_pum.data.id=current_pum.id,return_obj.patient_uses_module=current_pum.data,return_obj.stay_id=current_pum.data.stay_id)})),return_obj.stay_id&&resp.stays.forEach(function(current_stay,stayID){current_stay.id===return_obj.stay_id&&(return_obj.stay_found=!0,current_stay.data.id=current_stay.id,current_stay.data.fid=current_stay.id,current_stay.data=createStayExtras(current_stay.data),return_obj.stay=current_stay.data)}),calculation_results.forEach(function(current_calculation_top,calculationID){var calculation_name=current_calculation_top.name;current_calculation_top.result.length>0&&current_calculation_top.result.forEach(function(current_calculation,calculationID){var variant_info=!1;"info"in current_calculation&&"response"in current_calculation.info&&(variant_info=!0);var variant_response=!1;if("response"in current_calculation&&"data"in current_calculation.response&&"response"in current_calculation.response.data&&(variant_response=!0),variant_info){var calc_resp=current_calculation.info.response;JSON.stringify(calc_resp)===JSON.stringify(return_obj.response)&&(return_obj.calculation_found=!0,return_obj.calculation_found_method="variant_info",return_obj.calculation[calculation_name]=current_calculation)}if(variant_response){calc_resp=current_calculation.response.data.response;JSON.stringify(calc_resp)===JSON.stringify(return_obj.response)?(return_obj.calculation_found=!0,return_obj.calculation_found_method="variant_response",return_obj.calculation[calculation_name]=current_calculation):"TMTAError"in calc_resp&&parseInt(calc_resp.TMTAError)===parseInt(return_obj.response.TMTAError)&&parseInt(calc_resp.TMTATime)===parseInt(return_obj.response.TMTATime)&&parseInt(calc_resp.TMTBError)===parseInt(return_obj.response.TMTBError)&&parseInt(calc_resp.TMTBTime)===parseInt(return_obj.response.TMTBTime)&&parseInt(calc_resp.Ausbildungsjahre)===parseInt(return_obj.response.Ausbildungsjahre)&&parseInt(calc_resp.Messzeitpunkt)===parseInt(return_obj.response.Messzeitpunkt)&&(return_obj.calculation_found=!0,return_obj.calculation_found_method="variant_response_tmt",return_obj.calculation[calculation_name]=current_calculation)}})}),return_obj.calculation_found&&return_obj.event_found&&return_obj.patient_found&&return_obj.stay_found&&return_obj.patient_uses_module_found&&(return_obj.all_found=!0),return_array.push(return_obj)}),return_array.length>0){var have_data=!0;return_array.sort(function(a,b){var nameA=a.date.toUpperCase(),nameB=b.date.toUpperCase();return nameA<nameB?-1:nameA>nameB?1:0})}else have_data=!1;var response={date:new Date,data:return_array,calculations_all:calculation_results,have_data:have_data,possible_data:!0,request:data_request,pid:current_pid,fid:current_stay_id,app_id:app_id};console.log("(✔) Data ("+api_url+"):",response),commit({type:"saveData",root:"sr",data:response})}else{response={error:!0,error_message:"Failed with status code: "+req.status,status_code:req.status,request:data_request,app_id:app_id};console.error("(!) Error: ",response)}})}else{var response={error:!0,error_message:"Failed with status code: "+req.status,status_code:req.status,request:data_request,app_id:app_id};console.error("(!) Error: ",response)}})},getApps({commit:commit}){var api_url="module_activations",parameters={};helpers.callAPI("GET",api_url,parameters,{},function(req){if(200==req.status){var resp=JSON.parse(req.response),hotloaded=[];"patient_modules"in resp&&resp.patient_modules.length>0&&(resp.patient_modules.sort(function(a,b){var nameA=a.module.name.toUpperCase(),nameB=b.module.name.toUpperCase();return nameA<nameB?-1:nameA>nameB?1:0}),resp.patient_modules.forEach(function(m,mID){m.first_template={found:"false",name:null},m.identifier=m.module.identifier,m.module.templates.length>0&&(m.first_template.name=m.module.templates[0].name,m.first_template.found=!0),m.module_activation.data.overwritten&&hotloaded.push(m),m.identifier===helpers.getAppID()&&commit({type:"saveData",root:"current_app",data:m})})),"user_modules"in resp&&resp.user_modules.length>0&&(resp.user_modules.sort(function(a,b){var nameA=a.module.name.toUpperCase(),nameB=b.module.name.toUpperCase();return nameA<nameB?-1:nameA>nameB?1:0}),resp.user_modules.forEach(function(m,mID){m.first_template={found:"false",name:null},m.identifier=m.module.identifier,m.module.templates.length>0&&(m.first_template.name=m.module.templates[0].name,m.first_template.found=!0),m.module_activation.data.overwritten&&hotloaded.push(m),m.identifier===helpers.getAppID()&&commit({type:"saveData",root:"current_app",data:m})}));var response={data:{patient_modules:resp.patient_modules,user_modules:resp.user_modules,errors:resp.errors,hotloaded:hotloaded}};response=addOptinomicExtras(response,api_url),commit({type:"saveData",root:"apps",data:response}),console.log("(✔) Data ("+api_url+"):",response,parameters)}else{dispatch({type:"ERROR",error:handleError(req,{name:"getApps",params:[]})})}})},myincrement({commit:commit}){axios.get(helpers.getApiURL()+"clinic").then(response=>{console.log("RESP",response),commit("saveClinic",response),commit("increment")}).catch(error=>console.log("Error: clinic: ",error))}}}),methods:{buttonClick:function(){this.$store.commit("increment")},getClinic:function(){helpers.callAPI("GET","/clinic",{},{},function(req){if(200==req.status){var clinic=JSON.parse(req.response).clinic,clinic_obj={};clinic.forEach(function(current,ID){clinic_obj[current[0]]=current[1]});var response={data:{error:!1,clinic_array:clinic,clinic_obj:clinic_obj}};console.log("(✔) Data (/clinic):",response)}else{response={error:!0,error_message:"Failed with status code: "+req.status,status_code:req.status};console.error("(!) Error: ",response)}})},buttonTest:function(){axios.get(helpers.getApiURL()+"clinic").then(response=>{console.log("RESP",response),this.$store.commit("saveClinic",response)}).catch(error=>console.log("Error: clinic: ",error))}}});
</script>

[javascript]
function setValue(obj,access,value){if("string"==typeof access&&(access=access.split(".")),access.length>1){var init=obj[access[0]]||{};setValue(obj[access.shift()]=init,access,value)}else obj[access[0]]=value}addOptinomicExtras=function(obj,api_url){return api_url=api_url||null,obj.api_timestamp=(new Date).toISOString(),obj.api_url=api_url,obj},handleError=function(req,error_action){var error={error:!0,error_message:"Failed with status code: "+req.status,status:req.status,statusText:req.statusText,responseURL:req.responseURL,readyState:req.readyState,error_action:error_action};try{var responseText=JSON.parse(req.responseText);"error"in responseText&&(error.responseErrorText=responseText.error)}catch(err){error.responseErrorText=null}return 0!==req.status&&console.error("(!) "+req.status+" ("+req.statusText+")",error),error},debounce=function(fn,wait){var timeout=null,c=function(){clearTimeout(timeout),timeout=null},t=function(fn){timeout=setTimeout(fn,wait)};return function(){var context=this,args=arguments,f=function(){fn.apply(context,args)};timeout?c()||t(f):t(c)||f()}},formatDateCH=function(date_string){if(null!==(date_string=date_string||null)){var year=parseInt(date_string.substring(0,4)),month=parseInt(date_string.substring(5,7));return parseInt(date_string.substring(8,10))+"."+month+"."+year}return null},createPatientExtras=function(patient){var dateString,today,birthDate,age,m;patient.extras={},patient.extras.age=(dateString=patient.birthdate,today=new Date,birthDate=new Date(dateString),age=today.getFullYear()-birthDate.getFullYear(),((m=today.getMonth()-birthDate.getMonth())<0||0===m&&today.getDate()<birthDate.getDate())&&age--,age),patient.extras.birthday=formatDateCH(patient.birthdate),patient.extras.birthday_age=patient.extras.birthday+" | "+patient.extras.age,patient.extras.name=patient.last_name+" "+patient.first_name,"male"===patient.gender?(patient.extras.ansprache="Herr",patient.extras.anrede="Herr "+patient.last_name):(patient.extras.ansprache="Frau",patient.extras.anrede="Frau "+patient.last_name),patient.extras.full_name=patient.extras.ansprache+" "+patient.extras.name+" ("+patient.extras.birthday_age+")",patient.extras.full_address=patient.address1+", "+patient.zip_code+" "+patient.city;var myPhone="";patient.phone_home&&(myPhone=patient.phone_home),patient.phone_mobile&&(myPhone=""!=myPhone?myPhone+", "+patient.phone_mobile:patient.phone_mobile),patient.extras.phone=myPhone,patient.extras.infoline=patient.extras.full_address,""!=myPhone&&(patient.extras.infoline,patient.extras.phone);var myColor="#3F51B5",myColorAccent="#E91E63";return"female"===patient.gender&&(myColor="#E91E63",myColorAccent="#3F51B5"),patient.extras.color_main=myColor,patient.extras.color_accent=myColorAccent,patient.extras},createStayExtras=function(current_stay){current_stay.extras={},current_stay.extras.in_stay=!1,current_stay.stop?(current_stay.extras.duration=Math.floor((Date.parse(current_stay.stop)-Date.parse(current_stay.start))/864e5),current_stay.extras.duration=current_stay.extras.duration+1):current_stay.extras.duration=Math.floor((new Date-Date.parse(current_stay.start))/864e5);var phase=current_stay.phase,translated_de="";return"before_stay"===phase&&(translated_de="Bevorstehende Behandlung",translated_en="the stay starts in the future"),"in_stay"===phase&&(translated_de="In aktueller Behandlung",translated_en="the patient is currently in stay",current_stay.extras.in_stay=!0),"after_exit"===phase&&(translated_de="Die Behandlung wurde vor weniger als 14 Tage beendet",translated_en="the stay ended less than 14 days ago (included)"),"frozen"===phase&&(translated_de="Die Behandlung wurde manuell eingefroren",translated_en="the stay has manually been frozen (no more events, changes, ...)"),"unfrozen"===phase&&(translated_de="Die Behandlung ist abgeschlossen, wurde jedoch zur Bearbeitung wieder geöffnet",translated_en="the stay is complete but has been unfrozen by somebody"),"complete"===phase&&(translated_de="Die Behandlung wurde vor mehr als 14 Tage beendet",translated_en="the stay ended more than 14 days ago"),current_stay.extras.phase_de=translated_de,current_stay.extras.phase_en=translated_en,current_stay.extras.beginn=formatDateCH(current_stay.start),current_stay.extras.from_to=formatDateCH(current_stay.start),current_stay.extras.from_to=current_stay.extras.from_to+" - ",current_stay.stop?(current_stay.extras.from_to=current_stay.extras.from_to+formatDateCH(current_stay.stop),current_stay.extras.ende=formatDateCH(current_stay.stop)):current_stay.extras.from_to=current_stay.extras.from_to+"Unbekannt",current_stay.extras},createEventExtras=function(current_event){var extras={};return extras.created_at=formatDateCH(current_event.created_at),extras.due=formatDateCH(current_event.due),extras.status=current_event.status.charAt(0).toUpperCase()+current_event.status.slice(1),extras.status_de="Undefined","done"===current_event.status&&(extras.status_de="Erledigt",extras.show_do_it_now=!1),"to_be_done"===current_event.status&&(extras.status_de="Offen",extras.show_do_it_now=!0),"aborted"===current_event.status&&(extras.status_de="Abgebrochen",extras.show_do_it_now=!1),"irrelevant"===current_event.status&&(extras.status_de="Nicht relevant",extras.show_do_it_now=!1),extras};


[css]

[calculation rs13_score javascript]
function main(responses){var calc={roundToTwo:function(num){return+(Math.round(num+"e+2")+"e-2")},formatDateCH:function(date_string){if(null!==(date_string=date_string||null)){var year=parseInt(date_string.substring(0,4)),month=parseInt(date_string.substring(5,7));return parseInt(date_string.substring(8,10))+"."+month+"."+year}return null},getInterpretation:function(d,resp,score,range){var return_text="";return console.log("ddddd",resp),return_text="male"===d.patient.data.gender?"Herr "+d.patient.data.last_name:"Frau "+d.patient.data.last_name,return_text=(return_text=(return_text=(return_text+=" erreichte beim Resilienzfragebogen (RS-13) vom")+" "+calc.formatDateCH(resp.data.filled)+" ")+"einen Summenscore von "+score+", ")+"was auf eine "+range.interpretation_de+" hindeutet."},getResults:function(d){var allResults=[];return d.survey_responses.forEach(function(response,myindex){var myResults={rs13:{},rs13_score:0,interpretation:"",range:null,ranges:null},result=response.data.response;myResults.rs13.rs13_01=parseInt(result.rs13_01),myResults.rs13.rs13_02=parseInt(result.rs13_02),myResults.rs13.rs13_03=parseInt(result.rs13_03),myResults.rs13.rs13_04=parseInt(result.rs13_04),myResults.rs13.rs13_05=parseInt(result.rs13_05),myResults.rs13.rs13_06=parseInt(result.rs13_06),myResults.rs13.rs13_06=parseInt(result.rs13_06),myResults.rs13.rs13_07=parseInt(result.rs13_07),myResults.rs13.rs13_08=parseInt(result.rs13_08),myResults.rs13.rs13_09=parseInt(result.rs13_09),myResults.rs13.rs13_10=parseInt(result.rs13_10),myResults.rs13.rs13_11=parseInt(result.rs13_11),myResults.rs13.rs13_12=parseInt(result.rs13_12),myResults.rs13.rs13_13=parseInt(result.rs13_13),myResults.rs13_score=myResults.rs13.rs13_01+myResults.rs13.rs13_02+myResults.rs13.rs13_03+myResults.rs13.rs13_04+myResults.rs13.rs13_05+myResults.rs13.rs13_06+myResults.rs13.rs13_07+myResults.rs13.rs13_08+myResults.rs13.rs13_09+myResults.rs13.rs13_10+myResults.rs13.rs13_11+myResults.rs13.rs13_12+myResults.rs13.rs13_13;var current_range={},ranges=[{from:13,to:66,interpretation_de:"niedrige Widerstandskraft (Resilienz)",result_color:"#F44336"},{from:67,to:72,interpretation_de:"moderate Widerstandskraft (Resilienz)",result_color:"#FF9800"},{from:73,to:91,interpretation_de:"hohe Widerstandskraft (Resilienz)",result_color:"#4CAF50"}];current_range=ranges[0],myResults.rs13_score>=ranges[1].from&&(current_range=ranges[1]),myResults.rs13_score>=ranges[2].from&&(current_range=ranges[2]),myResults.range=current_range,myResults.ranges=ranges,myResults.interpretation=calc.getInterpretation(d,response,myResults.rs13_score,myResults.range),myResults.hash=result.optinomixHASH,myResults.response=response,allResults.push(myResults)}),allResults}};return calc.getResults(responses)}
